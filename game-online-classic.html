<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Монополія-lite: SHAG — Онлайн (Класична дошка)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    .board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); width: 90vmin; height: 90vmin; margin: 20px auto; }
    .tile { border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; background: white; }
    .center { grid-column: 2 / 11; grid-row: 2 / 11; display: flex; align-items: center; justify-content: center; }
    .panel { max-width: 400px; margin: 20px auto; background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
    button { padding: 8px 16px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; }
    button:disabled { background: #aaa; }
    input { padding: 6px; margin: 4px; }
    .log { max-height: 150px; overflow-y: auto; font-size: 12px; background: #fafafa; border: 1px solid #ddd; padding: 5px; }
  </style>
</head>
<body>

  <h1>Монополія-lite: <span style="color:#007bff">SHAG</span> — Онлайн (Класична дошка)</h1>

  <div class="panel">
    <label>Код кімнати (будь-яке слово):</label><br/>
    <input id="roomId" value="shag123" />
    <br/>
    <label>Твоє ім’я:</label><br/>
    <input id="playerName" value="Гравець" />
    <br/>
    <button onclick="createRoom()">Створити</button>
    <button onclick="joinRoom()">Приєднатись</button>
  </div>

  <div class="panel">
    <div id="gameArea" style="display:none;">
      <p><b>Гравці:</b> <span id="playersList"></span></p>
      <p><b>Хід:</b> <span id="turnOwner"></span></p>
      <p>
        <button id="rollBtn" onclick="rollDice()">Кинути кубики</button>
        <span id="diceRes"></span>
      </p>
      <div class="log" id="logBox"></div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    // Твій Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA1TdAheHUUB7FdA-4K7K1lt2sZt8FLBg",
      authDomain: "shag-monopoli.firebaseapp.com",
      databaseURL: "https://shag-monopoli-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "shag-monopoli",
      storageBucket: "shag-monopoli.appspot.com",
      messagingSenderId: "471245762028",
      appId: "1:471245762028:web:bb0ca1237521f01afa4c9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let UID = null;
    let ROOM_ID = null;

    // Авторизація
    firebase.auth().signInAnonymously().then(() => {
      UID = firebase.auth().currentUser.uid;
      console.log("Auth ok, UID:", UID);
    });

    async function ensureAuth() {
      if (!UID) {
        await firebase.auth().signInAnonymously();
        UID = firebase.auth().currentUser.uid;
      }
      return UID;
    }

    async function createRoom() {
      await ensureAuth();
      ROOM_ID = document.getElementById("roomId").value;
      const name = document.getElementById("playerName").value || "Гравець";

      const base = {
        state: { started:true, current:0, turnOwner:UID, dice:[1,1], order:[UID] },
        players: { [UID]: { name:name, cash:1500, pos:0 }},
        ownership: {},
        log: { 0: name + " створив кімнату" }
      };

      await db.ref("rooms/"+ROOM_ID).set(base);
      subscribeRoom();
    }

    async function joinRoom() {
      await ensureAuth();
      ROOM_ID = document.getElementById("roomId").value;
      const name = document.getElementById("playerName").value || "Гравець";

      const ref = db.ref("rooms/"+ROOM_ID+"/players/"+UID);
      await ref.set({ name:name, cash:1500, pos:0 });
      db.ref("rooms/"+ROOM_ID+"/state/order").once("value", snap=>{
        let order = snap.val()||[];
        if (!order.includes(UID)) {
          order.push(UID);
          db.ref("rooms/"+ROOM_ID+"/state/order").set(order);
        }
      });
      subscribeRoom();
    }

    function subscribeRoom() {
      document.getElementById("gameArea").style.display="block";
      db.ref("rooms/"+ROOM_ID).on("value", snap=>{
        const data = snap.val();
        if (!data) return;
        const players = data.players||{};
        document.getElementById("playersList").innerText = 
          Object.values(players).map(p=>p.name+" ("+p.cash+" ШАГ)").join(", ");
        document.getElementById("turnOwner").innerText = players[data.state.turnOwner]?.name||"—";
        document.getElementById("diceRes").innerText = data.state.dice.join(" + ");
        const logs = data.log?Object.values(data.log):[];
        document.getElementById("logBox").innerHTML = logs.reverse().join("<br/>");
        document.getElementById("rollBtn").disabled = (data.state.turnOwner!==UID);
      });
    }

    function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

    async function rollDice() {
      const d1=randInt(1,6), d2=randInt(1,6);
      const snap = await db.ref("rooms/"+ROOM_ID+"/state").once("value");
      const state = snap.val();
      state.dice=[d1,d2];
      const order = state.order||[];
      const idx = order.indexOf(state.turnOwner);
      const next = order[(idx+1)%order.length];
      state.turnOwner=next;
      await db.ref("rooms/"+ROOM_ID+"/state").set(state);
      await db.ref("rooms/"+ROOM_ID+"/log").push("Хід кубиків: "+d1+" + "+d2);
    }
  </script>
</body>
</html>
