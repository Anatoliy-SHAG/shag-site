<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SHAG Monopoly Online ‚Äî Classic Board</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- –®—Ä–∏—Ñ—Ç -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- –Ü–∫–æ–Ω–∫–∏ -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    :root{
      --acc:#0ea5e9;
      --panel: rgba(255,255,255,.88);
      --border:#e5e7eb;
    }
    .btn{border-radius:.75rem;padding:.55rem 1rem;background:var(--acc);color:#fff;transition:.15s}
    .btn:hover{filter:brightness(.95)} .btn:active{transform:scale(.98)}
    .btn-secondary{border-radius:.75rem;padding:.55rem 1rem;background:#334155;color:#fff;transition:.15s}
    .btn-secondary:hover{filter:brightness(.95)}
    .card{border-radius:1rem;background:var(--panel);backdrop-filter:blur(6px);
          border:1px solid var(--border);box-shadow:0 1px 2px rgba(0,0,0,.06);padding:1rem}
    .tile{border-radius:.75rem;border:1px solid var(--border);padding:.45rem}
    .mini{font-size:11px;opacity:.75}
    .pill{width:22px;height:22px;border-radius:9999px;display:grid;place-items:center;
          font-size:12px;font-weight:700;color:#fff;border:none}

    /* –ê–Ω—ñ–º–∞—Ü—ñ—è –∫—É–±–∏–∫—ñ–≤ */
    .shake { animation: shake .45s ease; }
    @keyframes shake {
      0%{transform:translate(0,0) rotate(0)}
      25%{transform:translate(1px,-1px) rotate(-2deg)}
      50%{transform:translate(-1px,1px) rotate(2deg)}
      75%{transform:translate(1px,0) rotate(-1deg)}
      100%{transform:translate(0,0) rotate(0)}
    }

    /* –ú–æ–±—ñ–ª—å–Ω–∏–π UX */
    @media (max-width: 520px){
      .btn,.btn-secondary{ padding:.7rem 1.05rem; font-size:1rem; }
      .card{ padding:.85rem; }
      .tile{ padding:.35rem; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
  <div class="max-w-6xl mx-auto p-3 md:p-6">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="card mb-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <i data-lucide="shield" class="w-6 h-6 text-sky-500"></i>
        <h1 class="text-2xl font-bold">–ú–æ–Ω–æ–ø–æ–ª—ñ—è-lite: <span class="text-sky-600">SHAG</span> ‚Äî –û–Ω–ª–∞–π–Ω (–ö–ª–∞—Å–∏—á–Ω–∞ –¥–æ—à–∫–∞)</h1>
      </div>
    </div>

    <!-- –ö–≤–∞–¥—Ä–∞—Ç 11x11 -->
    <div class="relative grid grid-cols-11 grid-rows-11 gap-1 md:gap-1.5">
      <!-- –¶–µ–Ω—Ç—Ä (–ª–æ–±—ñ + –ø–∞–Ω–µ–ª—å –≥—Ä–∏) -->
      <div class="card col-start-2 col-end-12 row-start-2 row-end-12 flex flex-col gap-3">
        <!-- –õ–æ–±—ñ -->
        <div id="lobby" class="grid md:grid-cols-3 gap-3">
          <div>
            <label class="mini block mb-1">–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ (–ª–∞—Ç/—Ü–∏—Ñ—Ä–∏)</label>
            <input id="roomId" class="w-full border rounded-xl p-2" placeholder="SHAG123">
          </div>
          <div>
            <label class="mini block mb-1">–¢–≤–æ—î —ñ–º º—è</label>
            <input id="playerName" class="w-full border rounded-xl p-2" placeholder="–ê–Ω–∞—Ç–æ–ª—ñ–π">
          </div>
          <div class="flex gap-2 items-end">
            <button id="btnCreate" class="btn flex-1"><i data-lucide="plus" class="w-4 h-4 mr-1"></i>–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
            <button id="btnJoin" class="btn-secondary flex-1"><i data-lucide="log-in" class="w-4 h-4 mr-1"></i>–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å</button>
          </div>
          <div class="md:col-span-3 mini opacity-70">
            –°—Ç–≤–æ—Ä–∏ –∞–±–æ –ø—Ä–∏—î–¥–Ω–∞–π—Å—è, –ø–æ—Ç—ñ–º ¬´–ü–æ—á–∞—Ç–∏ –≥—Ä—É¬ª. –•—ñ–¥ —Ä–æ–±–∏—Ç—å –ª–∏—à–µ –≥—Ä–∞–≤–µ—Ü—å, —á–∏–π UID —É –ø–æ–ª—ñ ¬´–•—ñ–¥¬ª.
          </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –≥—Ä–∏ -->
        <div id="panel" class="hidden">
          <div class="flex flex-wrap items-center gap-3">
            <div class="mini">–ö—ñ–º–Ω–∞—Ç–∞: <span id="roomInfo" class="font-semibold">‚Äî</span></div>
            <div class="mini">–¢–≤—ñ–π UID: <span id="uidInfo" class="font-semibold break-all">‚Äî</span></div>
            <div class="mini">–•—ñ–¥ (UID): <span id="turnOwnerInfo" class="font-semibold break-all">‚Äî</span></div>
            <div class="mini">–ü–æ—Ä—è–¥–æ–∫: <span id="orderInfo" class="font-semibold break-all">‚Äî</span></div>
            <div class="flex-1"></div>
            <button id="btnStartGame" class="btn"><i data-lucide="play" class="w-4 h-4 mr-1"></i>–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
            <button id="btnReset" class="btn-secondary"><i data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></i>–ù–æ–≤–∞ –≥—Ä–∞</button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            <div class="card">
              <div class="flex items-center gap-2">
                <button id="btnRoll" class="btn flex-1">
                  <i data-lucide="dice-6" class="w-4 h-4 mr-1"></i>–ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏
                </button>
                <div id="diceWrap" class="px-4 py-2 rounded-xl border bg-white text-center">
                  <div class="mini">–ö—É–±–∏–∫–∏</div>
                  <div id="diceBox" class="text-xl font-semibold">‚Äî + ‚Äî</div>
                </div>
              </div>
              <div class="text-sm mt-2">–•—ñ–¥: <span id="turnBox" class="font-semibold">‚Äî</span></div>
            </div>

            <div class="card">
              <h2 class="font-semibold mb-1 flex items-center gap-1">
                <i data-lucide="users" class="w-4 h-4"></i>–ì—Ä–∞–≤—Ü—ñ
              </h2>
              <div id="playersBox" class="space-y-2"></div>
            </div>

            <div class="card">
              <h2 class="font-semibold mb-1 flex items-center gap-1">
                <i data-lucide="megaphone" class="w-4 h-4"></i>–ü–æ–¥—ñ—ó
              </h2>
              <div id="logBox" class="space-y-2 max-h-56 overflow-auto"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- –ü–µ—Ä–∏–º–µ—Ç—Ä–Ω—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏ -->
      <div id="perimeter" class="contents"></div>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
  /* ===== –Ü–∫–æ–Ω–∫–∏ ===== */
  document.addEventListener('DOMContentLoaded', () => { if (window.lucide) lucide.createIcons(); });

  /* ===== Firebase Init (—Ç–≤—ñ–π config) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyA1TdAheHUUB7FdA-4K7K1lt2sZt8FLBg",
    authDomain: "shag-monopoli.firebaseapp.com",
    databaseURL: "https://shag-monopoli-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "shag-monopoli",
    storageBucket: "shag-monopoli.appspot.com",
    messagingSenderId: "471245762028",
    appId: "1:471245762028:web:bb0ca1237521f01afa4c9"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let UID = null;
  // –ø–µ—Ä—à–∏–π –≤—Ö—ñ–¥ (–º–æ–∂–µ –±—É—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  firebase.auth().signInAnonymously().then(() => {
    UID = firebase.auth().currentUser.uid;
  });

  // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é –ø–µ—Ä–µ–¥ –¥—ñ—è–º–∏
  async function ensureAuth() {
    try {
      if (!firebase.auth().currentUser) {
        await firebase.auth().signInAnonymously();
      }
      UID = firebase.auth().currentUser.uid;
      return true;
    } catch (e) {
      alert('Auth error: ' + (e?.message || e));
      return false;
    }
  }

  /* ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏/—É—Ç–∏–ª—ñ—Ç–∏ ===== */
  const START_CASH = 1500, PASS_START_REWARD = 200, JAIL_FINE = 100;
  const TileType = { START:'START', PROPERTY:'PROPERTY', CHANCE:'CHANCE', EVENT:'EVENT', JAIL:'JAIL', TAX:'TAX', EMPTY:'EMPTY' };
  const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  // –ö–æ–ª—å–æ—Ä–∏ —Ñ—ñ—à–æ–∫ —Ç–∞ –±–µ–π–¥–∂—ñ
  const COLORS = ['#06b6d4','#8b5cf6','#f59e0b','#ef4444','#22c55e','#e11d48','#0ea5e9','#14b8a6'];
  function playerBadge(name, idx){
    const init = (name||('G'+(idx+1))).trim().charAt(0).toUpperCase();
    const bg = COLORS[idx % COLORS.length];
    return `<div class="pill" style="background:${bg}">${init}</div>`;
  }

  /* ===== –ì–µ–æ–º–µ—Ç—Ä—ñ—è –∫–ª–∞—Å–∏—á–Ω–æ—ó –¥–æ—à–∫–∏ ===== */
  const SIZE = 11;
  const PERIM = SIZE*4 - 4; // 40
  function perimCoord(n){
    n = ((n%PERIM)+PERIM)%PERIM;
    const s = SIZE, last = s-1;
    if (n < s)                 return { r:last, c:n };                          // –Ω–∏–∑: 0..10
    if (n < s+(s-1))           return { r:last-(n-s+1), c:last };               // –ø—Ä–∞–≤–æ: 1..10
    if (n < s+(s-1)*2)         return { r:0, c:last-(n-(s+(s-1))+1) };          // –≤–µ—Ä—Ö: 1..10
    return { r:n-(s+(s-1)*2), c:0 };                                            // –ª—ñ–≤–æ: 1..9
  }

  /* ===== –¢–∞–π–ª–∏ (40 —à—Ç—É–∫) ===== */
  const tiles = [
    { id:0,  name:'–°–¢–ê–†–¢', type:TileType.START, color:'bg-white' },
    { id:1,  name:'–ö–∞—Ä–±–æ-–ª–µ–π–Ω', type:TileType.PROPERTY, price:60,  rent:20, color:'bg-rose-200' },
    { id:2,  name:'–®–∞–Ω—Å',       type:TileType.CHANCE,   color:'bg-amber-200' },
    { id:3,  name:'–®–∞—Ö—Ç–∞—Ä—Å—å–∫–∞', type:TileType.PROPERTY, price:80,  rent:30, color:'bg-rose-200' },
    { id:4,  name:'–ü–æ–¥–∞—Ç–æ–∫',    type:TileType.TAX,      tax:100,   color:'bg-gray-200' },
    { id:5,  name:'–ù–æ–¥–∞ RPC',   type:TileType.PROPERTY, price:120, rent:40, color:'bg-blue-200' },
    { id:6,  name:'–°–æ–ª–æ-–º–∞–π–Ω',  type:TileType.PROPERTY, price:140, rent:45, color:'bg-emerald-200' },
    { id:7,  name:'–ü–æ–¥—ñ—è',      type:TileType.EVENT,    color:'bg-amber-200' },
    { id:8,  name:'–ï–∫—Å–ø–ª–æ—Ä–µ—Ä',  type:TileType.PROPERTY, price:160, rent:55, color:'bg-emerald-200' },
    { id:9,  name:'–í–µ–±-–ì–∞–º–∞–Ω–µ—Ü—å', type:TileType.PROPERTY, price:180, rent:65, color:'bg-violet-200' },

    { id:10, name:'–¢–Æ–†–ú–ê',      type:TileType.JAIL,     color:'bg-gray-100' },

    { id:11, name:'–ü—É–ª',        type:TileType.PROPERTY, price:200, rent:70, color:'bg-sky-200' },
    { id:12, name:'API-–®–ª—é–∑',   type:TileType.PROPERTY, price:220, rent:80, color:'bg-sky-200' },
    { id:13, name:'–®–∞–Ω—Å',       type:TileType.CHANCE,   color:'bg-amber-200' },
    { id:14, name:'–•–æ—Å—Ç–∏–Ω–≥',    type:TileType.PROPERTY, price:240, rent:90, color:'bg-violet-200' },
    { id:15, name:'–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥',  type:TileType.PROPERTY, price:260, rent:95, color:'bg-yellow-200' },
    { id:16, name:'–ü–æ–¥—ñ—è',      type:TileType.EVENT,    color:'bg-amber-200' },
    { id:17, name:'–õ—ñ—Å—Ç–∏–Ω–≥ DEX',type:TileType.PROPERTY, price:280, rent:110, color:'bg-yellow-200' },
    { id:18, name:'–ë—ñ—Ä–∂–∞ CEX',  type:TileType.PROPERTY, price:320, rent:130, color:'bg-yellow-200' },
    { id:19, name:'–õ—ñ—Ü–µ–Ω–∑—ñ—ó',   type:TileType.TAX,      tax:150,   color:'bg-gray-200' },

    { id:20, name:'–í—ñ–¥–ø–æ—á–∏–Ω–æ–∫', type:TileType.EMPTY,    color:'bg-white' },

    { id:21, name:'–°–µ—Ä–≤–µ—Ä–∞',    type:TileType.PROPERTY, price:340, rent:140, color:'bg-blue-100' },
    { id:22, name:'UX-—Ä–µ–¥–∏–∑–∞–π–Ω',type:TileType.PROPERTY, price:360, rent:160, color:'bg-pink-200' },
    { id:23, name:'–®–∞–Ω—Å',       type:TileType.CHANCE,   color:'bg-amber-200' },
    { id:24, name:'–†–µ–∫–ª–∞–º–Ω–∞ —Å—ñ—Ç–∫–∞', type:TileType.PROPERTY, price:380, rent:170, color:'bg-pink-200' },
    { id:25, name:'–ü–æ–¥—ñ—è',      type:TileType.EVENT,    color:'bg-amber-200' },
    { id:26, name:'CDN/Edge',   type:TileType.PROPERTY, price:400, rent:190, color:'bg-indigo-200' },
    { id:27, name:'–ê—É–¥–∏—Ç',      type:TileType.TAX,      tax:200,   color:'bg-gray-200' },
    { id:28, name:'–ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ',type:TileType.PROPERTY, price:420, rent:200, color:'bg-green-200' },
    { id:29, name:'Data Lake',  type:TileType.PROPERTY, price:440, rent:220, color:'bg-cyan-200' },

    { id:30, name:'–£ –¢–Æ–†–ú–£!',   type:TileType.EVENT,    color:'bg-gray-100' },

    { id:31, name:'–ó–ü Dev',     type:TileType.PROPERTY, price:460, rent:230, color:'bg-purple-200' },
    { id:32, name:'–ê–∫—Å–µ–ª–µ—Ä–∞—Ç–æ—Ä',type:TileType.PROPERTY, price:480, rent:240, color:'bg-amber-100' },
    { id:33, name:'–®–∞–Ω—Å',       type:TileType.CHANCE,   color:'bg-amber-200' },
    { id:34, name:'–ê/–ë –¢–µ—Å—Ç–∏',  type:TileType.PROPERTY, price:500, rent:260, color:'bg-lime-200' },
    { id:35, name:'–ü–æ–¥—ñ—è',      type:TileType.EVENT,    color:'bg-amber-200' },
    { id:36, name:'–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó', type:TileType.PROPERTY, price:520, rent:270, color:'bg-teal-200' },
    { id:37, name:'–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è',type:TileType.PROPERTY, price:540, rent:290, color:'bg-rose-100' },
    { id:38, name:'–ü–æ–¥–∞—Ç–æ–∫',    type:TileType.TAX,      tax:250,   color:'bg-gray-200' },
    { id:39, name:'–§—ñ–Ω—ñ—à/–°–¢–ê–†–¢',type:TileType.START,    color:'bg-white' },
  ];

  const chanceDeck = [
    { text:'–ë–æ–Ω—É—Å –º–∞–π–Ω–µ—Ä–∞: +100 –®–ê–ì',      effect:(p)=>p.cash+=100 },
    { text:'–û–ø–ª–∞—Ç–∞ –∑–∞ —Ö–æ—Å—Ç–∏–Ω–≥: ‚àí100 –®–ê–ì',  effect:(p)=>p.cash-=100 },
    { text:'Airdrop SHAG: +200 –®–ê–ì',       effect:(p)=>p.cash+=200 },
    { text:'–ü—ñ–∞—Ä-–ø–æ—Å—Ç –∑–ª—ñ—Ç–∞—î: +150 –®–ê–ì',   effect:(p)=>p.cash+=150 },
    { text:'–ê—É–¥–∏—Ç —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—É: ‚àí200',  effect:(p)=>p.cash-=200 },
  ];
  const eventDeck = [
    { text:'–ô–¥–∏ –Ω–∞ –°—Ç–∞—Ä—Ç —ñ –≤—ñ–∑—å–º–∏ –≤–∏–Ω–∞–≥–æ—Ä–æ–¥—É', effect:(p,setPos)=>setPos(0,true) },
    { text:'–ô–¥–∏ –≤ –¢—é—Ä–º—É (–±–µ–∑ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –°—Ç–∞—Ä—Ç—É)', effect:(p,setPos)=>setPos(10,false) },
    { text:'–ü—Ä–æ—Å—É–Ω—å—Å—è –Ω–∞ 3 –∫–ª—ñ—Ç–∏–Ω–∫–∏', effect:(p,setPos,pos)=>setPos((pos+3)%tiles.length, (pos+3)%tiles.length<pos) },
    { text:'–í—ñ–¥–∫–æ—Ç —Ä–µ–ª—ñ–∑—É: –≤—ñ–¥—Å—Ç—É–ø–∏ –Ω–∞ 2', effect:(p,setPos,pos)=>setPos((pos+tiles.length-2)%tiles.length,false) },
  ];

  /* ===== DOM ===== */
  const perimeter = document.getElementById('perimeter');
  const lobby = document.getElementById('lobby');
  const panel = document.getElementById('panel');
  const roomIdEl = document.getElementById('roomId');
  const playerNameEl = document.getElementById('playerName');
  const btnCreate = document.getElementById('btnCreate');
  const btnJoin   = document.getElementById('btnJoin');
  const roomInfo = document.getElementById('roomInfo');
  const uidInfo  = document.getElementById('uidInfo');
  const turnOwnerInfo = document.getElementById('turnOwnerInfo');
  const orderInfo = document.getElementById('orderInfo');
  const btnStartGame = document.getElementById('btnStartGame');
  const btnReset = document.getElementById('btnReset');
  const btnRoll = document.getElementById('btnRoll');
  const diceWrap = document.getElementById('diceWrap');
  const diceBox = document.getElementById('diceBox');
  const turnBox = document.getElementById('turnBox');
  const playersBox = document.getElementById('playersBox');
  const logBox = document.getElementById('logBox');

  /* ===== –†–µ–Ω–¥–µ—Ä –ø–µ—Ä–∏–º–µ—Ç—Ä–∞ ===== */
  function renderPerimeter(room){
    perimeter.innerHTML = '';
    for(let i=0;i<PERIM;i++){
      const t = tiles[i];
      const {r,c} = perimCoord(i);
      const d = document.createElement('div');
      d.style.gridRowStart = r+1;
      d.style.gridColumnStart = c+1;
      d.className = `tile ${t.color||'bg-white'}`;
      d.innerHTML = `
        <div class="text-[11px] font-semibold leading-4 truncate flex items-center gap-1">
          ${iconForTile(t)} <span>${t.name}</span>
        </div>
        ${t.type==='PROPERTY' ? `<div class="mini">–¶—ñ–Ω–∞: ${t.price} ‚Ä¢ –†–µ–Ω—Ç–∞: ${t.rent}</div>` : ''}
        ${t.type==='TAX' ? `<div class="mini">–ü–æ–¥–∞—Ç–æ–∫: ${t.tax}</div>` : ''}
        <div class="flex -space-x-1 mt-1" data-here="${i}"></div>
        <div class="mini opacity-60" data-owner="${i}"></div>
      `;
      perimeter.appendChild(d);
    }

    if(room){
      const ownership = room.ownership || {};
      Object.entries(ownership).forEach(([tileId, ownerUid])=>{
        const el = perimeter.querySelector(`[data-owner="${tileId}"]`);
        if(!el) return;
        const name = room.players && room.players[ownerUid] ? room.players[ownerUid].name : ownerUid;
        el.textContent = ownerUid ? `–í–ª–∞—Å–Ω–∏–∫: ${name}` : '';
      });

      const players = room.players || {};
      const orderKeys = (room.state && room.state.order) || Object.keys(players);
      orderKeys.forEach((uid, idx)=>{
        const p = players[uid]; if(!p) return;
        const pos = (p.pos||0) % tiles.length;
        const slot = perimeter.querySelector(`[data-here="${pos}"]`);
        if(slot){ slot.insertAdjacentHTML('beforeend', playerBadge(p.name, idx)); }
      });
    }

    if (window.lucide) lucide.createIcons();
  }

  function iconForTile(t){
    const map = {
      START:'rocket', PROPERTY:'building-2', CHANCE:'help-circle', EVENT:'sparkles',
      JAIL:'gavel', TAX:'dollar-sign', EMPTY:'coffee'
    };
    const name = map[t.type] || 'square';
    return `<i data-lucide="${name}" class="w-3.5 h-3.5 opacity-70"></i>`;
  }

  function renderPlayers(room) {
    playersBox.innerHTML='';
    const players = room.players || {};
    const order = (room.state && room.state.order) || Object.keys(players);
    order.forEach((uid, idx)=>{
      const p = players[uid]; if(!p) return;
      const isTurn = room.state && room.state.turnOwner === uid;
      const row=document.createElement('div');
      row.className='rounded-xl p-3 border bg-white '+(isTurn?'ring-2 ring-sky-400':'');
      row.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-2">
            ${playerBadge(p.name, idx)}
            <div class="font-semibold">${p.name||uid}</div>
          </div>
          <div class="text-sm">${p.cash ?? 0} –®–ê–ì</div>
        </div>
        <div class="text-xs opacity-70 mt-1">
          –ü–æ–∑–∏—Ü—ñ—è: ${p.pos ?? 0} ‚Ä¢ ${p.inJail?`–¢—é—Ä–º–∞ (${p.jailTurns||0})`:'–í—ñ–ª—å–Ω–∏–π'} ‚Ä¢ ${p.bankrupt?'–ë–∞–Ω–∫—Ä—É—Ç':'–ê–∫—Ç–∏–≤–Ω–∏–π'}
          ‚Ä¢ ${p.connected?'üü¢ –æ–Ω–ª–∞–π–Ω':'‚ö´ –æ—Ñ–ª–∞–π–Ω'}
        </div>
      `;
      playersBox.appendChild(row);
    });
  }

  function renderLog(room) {
    const log = room.log || {};
    const entries = Object.values(log);
    entries.sort((a,b)=> (a.t||0) < (b.t||0) ? 1 : -1);
    logBox.innerHTML = entries.slice(0,120).map(e=>(
      `<div class="text-sm bg-white border rounded-xl p-2">${e.msg}</div>`
    )).join('');
  }

  function updateHUD(room) {
    if(!room || !room.state) return;
    diceBox.textContent = (room.state.dice||[1,1]).join(' + ');
    const players = room.players || {};
    const myName = players[UID]?.name || UID;
    turnBox.textContent = myName;
    turnOwnerInfo.textContent = room.state.turnOwner || '‚Äî';
    orderInfo.textContent = (room.state.order||[]).join(', ');
  }

  /* ===== –û–Ω–ª–∞–π–Ω –ª–æ–≥—ñ–∫–∞ (Firebase) ===== */
  let ROOM_ID = null;
  function roomRef(path='') { return db.ref(`rooms/${ROOM_ID}${path}`); }

  async function createRoom() {
    if (!(await ensureAuth())) return;

    ROOM_ID = (roomIdEl.value || '').trim();
    const name = (playerNameEl.value||'–ì—Ä–∞–≤–µ—Ü—å').trim() || '–ì—Ä–∞–≤–µ—Ü—å';
    if(!ROOM_ID) return alert('–í–≤–µ–¥–∏ –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏');

    const base = {
      state: { started:false, current:0, turnOwner:null, dice:[1,1], order:[] },
      players: {},
      ownership: {},
      log: {}
    };
    try {
      await db.ref(`rooms/${ROOM_ID}`).set(base);
      await joinRoomInternal(name);
    } catch (e) {
      alert('DB write error: ' + (e?.message || e));
    }
  }

  async function joinRoom() {
    if (!(await ensureAuth())) return;

    ROOM_ID = (roomIdEl.value || '').trim();
    const name = (playerNameEl.value||'–ì—Ä–∞–≤–µ—Ü—å').trim() || '–ì—Ä–∞–≤–µ—Ü—å';
    if(!ROOM_ID) return alert('–í–≤–µ–¥–∏ –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏');

    try {
      await joinRoomInternal(name);
    } catch (e) {
      alert('Join error: ' + (e?.message || e));
    }
  }

  async function joinRoomInternal(name) {
    lobby.classList.add('hidden');
    panel.classList.remove('hidden');
    roomInfo.textContent = ROOM_ID;

    // presence
    const pRef = roomRef(`/players/${UID}`);
    const connRef = db.ref('.info/connected');
    connRef.on('value', snap => {
      if (snap.val() === true) {
        pRef.onDisconnect().update({ connected:false });
        pRef.update({ name, cash:START_CASH, pos:0, inJail:false, bankrupt:false, connected:true });
      }
    });

    // subscribe
    roomRef().on('value', (snap)=>{
      const room = snap.val() || {};
      renderPerimeter(room);
      renderPlayers(room);
      renderLog(room);
      updateHUD(room);
    });
  }

  async function appendLogOnline(msg) {
    const entry = { t: Date.now(), msg };
    await roomRef('/log').push(entry);
  }

  async function startGameOnline() {
    const snap = await roomRef().get();
    const room = snap.val() || {};
    const players = room.players || {};
    const order = Object.keys(players); // –ø–æ—Ä—è–¥–æ–∫ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

    await roomRef('/state').update({
      started: true,
      current: 0,
      turnOwner: order[0] || null,
      order
    });
    await appendLogOnline('–ì—Ä—É —Ä–æ–∑–ø–æ—á–∞—Ç–æ! –£—Å–ø—ñ—Ö—ñ–≤!');
  }

  function applyChance(p) {
    const card = chanceDeck[randInt(0, chanceDeck.length-1)];
    card.effect(p);
    return `¬´–®–∞–Ω—Å¬ª: ${card.text}`;
  }
  function applyEvent(room, uid) {
    if ((room.players[uid].pos||0) === 30) { // Go To Jail
      room.players[uid].pos = 10;
      room.players[uid].inJail = true;
      room.players[uid].jailTurns = 2;
      return `–ü–æ–¥—ñ—è: ¬´–ô–¥–∏ –≤ —Ç—é—Ä–º—É¬ª (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫—É 10).`;
    }
    const card = eventDeck[randInt(0, eventDeck.length-1)];
    const pos = room.players[uid].pos || 0;
    const setPos = (target, withStart)=>{
      let t = (typeof target==='function') ? target(pos) : target;
      if (t<0) t=0;
      room.players[uid].pos = t % tiles.length;
      if (withStart===true) { room.players[uid].cash += PASS_START_REWARD; }
    };
    card.effect(room.players[uid], setPos, pos);
    return `¬´–ü–æ–¥—ñ—è¬ª: ${card.text}`;
  }

  async function rollDiceOnline() {
    diceWrap.classList.remove('shake'); void diceWrap.offsetWidth; diceWrap.classList.add('shake');

    const s = await roomRef().get();
    const room = s.val();
    if (!room || !room.state) return;
    if (room.state.turnOwner !== UID) return alert('–ó–∞—Ä–∞–∑ –Ω–µ —Ç–≤—ñ–π —Ö—ñ–¥');

    const d1 = randInt(1,6), d2 = randInt(1,6), steps = d1+d2;

    await roomRef().transaction((data)=>{
      if(!data || !data.state) return data;
      const players = data.players || {};
      const me = players[UID]; if(!me || me.bankrupt) return data;

      data.state.dice = [d1, d2];

      const old = me.pos || 0;
      const next = (old + steps) % tiles.length;
      const passedStart = old + steps >= tiles.length;
      me.pos = next;
      if (passedStart) { me.cash = (me.cash||0) + PASS_START_REWARD; }

      const tile = tiles[next];
      let logMsg = `${me.name||UID} –∫–∏–¥–∞—î ${d1}+${d2} —Ç–∞ —Å—Ç–∞—î –Ω–∞ ¬´${tile.name}¬ª. `;

      if (tile.type=== 'TAX') { me.cash -= tile.tax; logMsg += `–ü–æ–¥–∞—Ç–æ–∫ ‚àí${tile.tax} –®–ê–ì.`; }
      else if (tile.type=== 'JAIL') { me.inJail = true; me.jailTurns = 2; logMsg += `–¢—é—Ä–º–∞ –Ω–∞ 2 —Ö–æ–¥–∏.`; }
      else if (tile.type=== 'CHANCE') { logMsg += applyChance(me); }
      else if (tile.type=== 'EVENT') { logMsg += applyEvent(data, UID); }
      else if (tile.type=== 'PROPERTY') {
        const owner = (data.ownership||{})[String(next)];
        if (!owner) {
          if ((me.cash||0) >= tile.price) {
            data.ownership = data.ownership || {};
            data.ownership[String(next)] = UID;
            me.cash -= tile.price;
            logMsg += `–ö—É–ø—É—î –∑–∞ ${tile.price} –®–ê–ì.`;
          } else {
            logMsg += `–ù–µ –≤–∏—Å—Ç–∞—á–∞—î –Ω–∞ –∫—É–ø—ñ–≤–ª—é (${tile.price} –®–ê–ì).`;
          }
        } else if (owner !== UID) {
          const rent = tile.rent;
          me.cash -= rent;
          if (data.players[owner]) data.players[owner].cash += rent;
          logMsg += `–ü–ª–∞—Ç–∏—Ç—å —Ä–µ–Ω—Ç—É ${rent} –®–ê–ì –≥—Ä–∞–≤—Ü—é ${data.players[owner]?.name||owner}.`;
        }
      }

      if ((me.cash||0) < -200) {
        me.bankrupt = true;
        Object.keys(data.ownership||{}).forEach(k => { if (data.ownership[k]===UID) delete data.ownership[k]; });
        logMsg += ` ${me.name||UID} –±–∞–Ω–∫—Ä—É—Ç —ñ –≤–∏–±—É–≤–∞—î.`;
      }

      const order = data.state.order || Object.keys(players);
      if (!order.length) return data;
      const idx = order.indexOf(UID);
      const nextIdx = (idx + 1) % order.length;
      data.state.current = nextIdx;
      data.state.turnOwner = order[nextIdx];

      const entryKey = db.ref().push().key;
      data.log = data.log || {};
      data.log[entryKey] = { t: Date.now(), msg: logMsg };

      return data;
    });
  }

  async function resetOnline() {
    if(!ROOM_ID) return;
    await roomRef().update({
      state: { started:false, current:0, turnOwner:null, dice:[1,1], order:[] },
      ownership: {},
    });
    await roomRef('/players').get().then(snap=>{
      const p = snap.val()||{};
      Object.keys(p).forEach(uid=>{
        roomRef(`/players/${uid}`).update({ cash:START_CASH, pos:0, inJail:false, jailTurns:0, bankrupt:false });
      });
    });
    await appendLogOnline('–ì—Ä—É —Å–∫–∏–Ω—É—Ç–æ.');
  }

  /* ===== –ü–æ–¥—ñ—ó UI ===== */
  btnCreate.onclick = createRoom;
  btnJoin.onclick   = joinRoom;
  btnStartGame.onclick = startGameOnline;
  btnRoll.onclick = rollDiceOnline;
  btnReset.onclick = resetOnline;

  /* ===== –ü–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä –ø–æ—Ä–æ–∂–Ω—å–æ—ó –¥–æ—à–∫–∏ ===== */
  (function initBoardOnce(){
    renderPerimeter(null);
    if (window.lucide) lucide.createIcons();
  })();
  </script>
</body>
</html>
